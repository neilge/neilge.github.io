---
title: 29-10-17
date: 2017-10-29 20:57:16
tags: Weekly Work Log
visible: hide
---

## Ajax Controller

### How ajax controller work

The main method is editPaymentMethod. First it will get customerId, paymentInstrumentId and makrketplaceId from other services and at then same time, get the csrfToken from request. Then the token will be validated. If the token is valid, we can create address from request data. 
The next step is add or edit the paymentInstrument whose type is determined by the parameter in the http request. 
The most important part is how to add and edit.

Edit is very similar to add. We just take add as example.

When add an instrument, we first create an instrument instance and then register it to the amazon wallet. This part is handled by the paymentManager which called the converter to convert audible payment instrument to amazon payment instrument. Then check if the payment instrument exists or not to select the return status as add or edit. If the customer also set the current payment as default payment, we need to check it succeed or not. Therefore there are 6 different return status.  

Add success Default success
Add success Default fail
Add fail 

Edit success Default success
Edit success Default fail
Edit fail 

Finally the editPaymentMethod will return a pageModel which is attached with a json object. It could be success or fail.

### Dependency and runtime dependency

When we open the Config file, we would find there is a dependencies and a runtime-dependencies. The dependencies should include all the packages that we need at compile time (Interface packages) and those would be necessary at runtime would be put into runtime-dependencies (Lib packages). 

I have came cross a compile fail just because this issue. There is a test code that does not use mock but create an instance for a service which make the Lib is necessary at build time. (Becaues we run test at build time)(Build time is compile time, I think). But if we do not turn on findbug, this error won't occur (maybe it is not a big deal). But I change the code and turn on the findbug, then I found there is a build error and I cannot find it why it occured.

### What is Lib and Interface

Lib is the implementation of Interface.

## AryaAuthportal

There are several filters in the packages and they are called at different time. 

The parameter cleanup filter is used when we force a user sign out or a user request a page that he does not have the access, we would keep the users previous pages information or url information. After the user successfully logined in, we would redirect the customer to the page he was at or he requested. 

However, the authentication is done by amazon, not us and amazon will attached many parameters which might not be necessary for us. Therefore, we need to clean them at a place. (Normally after successfully logined in)

## Feature in specific realm

We can implement this by using two diffferent ways.

1. Brazil config: 
	* set the configuration in `coinfiguraiton -> brazil-config -> global -> *.cfg` files
	* get the configured feature by using configRetriever
2. featureToggle: 
	* In `java -> * -> configuration` file, create two beans, one is for enabled feature and the other is disabledFeature. 
	* Then we can get the feature by featureToggle
	* Refer to https://w.amazon.com/index.php/Arya/UsersGuide/Integrations/FeatureToggle

## Weblab

We might now have two ways to fake the weblab turn on. 

1. js, weblab bookmarker
2. integrationtest=1, need to check the file if has the setting. please refer to `handleAccountDetailsWeblabRedirects` in `AccountDetailsRedirectUtils`.